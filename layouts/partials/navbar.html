{{/* Default data */}}
{{ $logo := "img/default-logo.svg" }}
{{ $logoLink := "/" }}
{{ $title := "#hugo-porto" }}

{{ $buttonEnabled := true }}
{{ $buttonText := "Download CV" }}
{{ $buttonLink := "#" }}
{{ $buttonTarget := "_blank" }}

{{ $menu := slice
  (dict "link" "/" "target" "_self" "text" "Home" "description" "Navigate to home page")
  (dict "link" "/posts" "target" "_self" "text" "Posts" "description" "Navigate to posts section")
  (dict "link" "/tags" "target" "_self" "text" "Tags" "description" "Navigate to tags section")
}}

{{/* Custom data from configuration file */}}
{{ with site.Data.navbar }}
  {{ $menu = slice }}
  {{ $buttonEnabled = false }}
  {{ $themeToggleEnabled := false }}
  {{ if .menu }}{{ $menu = .menu }}{{ end }}
  {{ if .title }}{{ $title = .title }}{{ end }}
  {{ if .logo }}{{ $logo = .logo }}{{ end }}
  {{ if .logoLink }}{{ $logoLink = .logoLink }}{{ else if .site.BaseURL }}{{ $logoLink = .site.BaseURL }}{{ end }}
  {{ if .button }}
    {{ if .button.enabled }}{{ $buttonEnabled = .button.enabled }}{{ end }}
    {{ if .button.text }}{{ $buttonText = .button.text }}{{ end }}
    {{ if .button.link }}{{ $buttonLink = .button.link }}{{ end }}
    {{ if .button.target }}{{ $buttonTarget = .button.target }}{{ end }}
  {{ end }}
{{ end }}

{{/* If logo is a local asset, resize */}}
{{ $logoResource := resources.Get $logo }}
{{ if $logoResource }}
  {{ if eq $logoResource.MediaType.SubType "svg" }}
    {{ $logo = $logoResource.RelPermalink }}
  {{ else }}
    {{ $logo = ($logoResource.Resize "100x100").RelPermalink }}
  {{ end }}
{{ end }}


<div class="flex items-center justify-between py-5">
  <div class="flex items-center">
    <a href="{{ $logoLink }}">
      <img src="{{ $logo }}" class="py-5 w-10 lg:w-14 min-w-10" alt="{{ $title }}" title="{{ $title }}" />
    </a>
    <a href="{{ $logoLink }}">
      <h1 class="text-lg lg:text-xl px-2 lg:px-3 font-medium">{{ $title }}</h1>
    </a>
  </div>
  <div class="hidden lg:block">
    <ul class="flex items-center">
      {{ range $menu }}
        <li class="px-5">
          <a
            href="{{ .link }}"
            alt="{{ .description }}"
            title="{{ .description }}"
            target="{{ .target }}"
            class="cursor-pointer font-normal text-base">
            {{ .text }}
          </a>
        </li>
      {{ end }}
      {{ if $buttonEnabled }}
        <li class="px-5">
          <a href="{{ $buttonLink }}" target="{{ $buttonTarget }}">
            <button
              class="cursor-pointer px-10 py-4 bg-white hover:bg-gray-600 hover:text-white rounded-lg font-normal text-base transition duration-300">
              {{ $buttonText }}
            </button>
          </a>
        </li>
      {{ end }}
      {{ with site.Data.navbar.themeToggle }}
        {{ if .enabled }}
          <li class="px-3 flex items-center">
            <button
              id="theme-toggle-desktop"
              type="button"
              aria-label="Toggle theme"
              class="cursor-pointer p-2 rounded flex items-center justify-center ml-3"
              onclick="window.__cyclePreferredTheme()">
              <i class="bx bx-desktop text-xl"></i>
            </button>
          </li>
        {{ end }}
      {{ end }}
    </ul>
  </div>

  <div class="block lg:hidden mt-2">
    <button @click="mobileMenu = true">
      <i class="bx bx-menu text-3xl"></i>
    </button>
  </div>
</div>

<script>
  (function () {
    function iconFor(mode) {
      if (mode === "dark") return "bx bx-moon text-xl";
      if (mode === "light") return "bx bx-sun text-xl";
      return "bx bx-desktop text-xl";
    }
    function updateIcon(btn) {
      if (!btn) return;
      var icon = btn.querySelector("i");
      var mode = window.__getPreferredTheme ? window.__getPreferredTheme() : window.__theme || "system";
      if (icon) {
        icon.className = iconFor(mode);
      }
    }
    function nextMode(mode) {
      return mode === "system" ? "dark" : mode === "dark" ? "light" : "system";
    }
    function labelForNext(mode) {
      var next = nextMode(mode);
      if (next === "dark") return "Switch to Dark";
      if (next === "light") return "Switch to Light";
      return "Switch to System";
    }
    function attach(btn) {
      if (!btn) return;
      if (btn.__themeAttached) return; // guard against double-attaching
      btn.__themeAttached = true;
      btn.addEventListener("click", function (e) {
        if (e && e.preventDefault) e.preventDefault();
        var next = window.__cyclePreferredTheme();
        updateAllIcons();
      });
      updateIcon(btn);
    }
    function updateAllIcons() {
      // Attach only once (attach has internal guard), then update icons
      var d = document.getElementById("theme-toggle-desktop");
      if (d) attach(d);
      if (d) updateIcon(d);
      var m = document.getElementById("theme-toggle-mobile");
      if (m) attach(m);
      if (m) {
        // mobile UI uses a label instead of an icon
        var label = document.getElementById("theme-toggle-mobile-label");
        var mode = window.__getPreferredTheme ? window.__getPreferredTheme() : window.__theme || "system";
        if (label) label.textContent = labelForNext(mode);
      }
    }
    updateAllIcons();
    // If mobile toggle isn't in DOM yet (it's in baseof after this partial), poll briefly and attach when available
    (function pollMobile() {
      var attempts = 0;
      var t = setInterval(function () {
        attempts++;
        if (document.getElementById("theme-toggle-mobile")) {
          clearInterval(t);
          updateAllIcons();
        }
        if (attempts > 20) {
          clearInterval(t);
        }
      }, 150);
    })();
    window.addEventListener("theme-changed", updateAllIcons);
  })();
</script>
